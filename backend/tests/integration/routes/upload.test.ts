/**
 * Upload Image Integration Tests
 *
 * WHAT THIS FILE TESTS:
 * ---------------------
 * Tests the image upload endpoint for user profile pictures.
 * - POST /api/auth/upload-image - Upload a profile image
 *
 * TESTING PATTERN: File Upload Testing
 * -------------------------------------
 * We use supertest's .attach() method to simulate multipart form data.
 * Test files are created in-memory using Buffer to avoid file system dependencies.
 *
 * NOTE: This endpoint does NOT require authentication (based on current routes).
 * If this changes, add authentication tests.
 */
import request from "supertest";
import path from "path";
import fs from "fs";
import { createApp } from "../../../app.js";

const app = createApp();

// ============================================================================
// HELPER: Create test image buffer
// ============================================================================

/**
 * Create a minimal valid PNG buffer for testing
 * This is a 1x1 pixel transparent PNG
 */
const createTestPngBuffer = (): Buffer => {
  // Minimal valid PNG file (1x1 transparent pixel)
  return Buffer.from([
    0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, // PNG signature
    0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52, // IHDR chunk
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
    0x08, 0x06, 0x00, 0x00, 0x00, 0x1f, 0x15, 0xc4,
    0x89, 0x00, 0x00, 0x00, 0x0a, 0x49, 0x44, 0x41, // IDAT chunk
    0x54, 0x78, 0x9c, 0x63, 0x00, 0x01, 0x00, 0x00,
    0x05, 0x00, 0x01, 0x0d, 0x0a, 0x2d, 0xb4, 0x00,
    0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae, // IEND chunk
    0x42, 0x60, 0x82,
  ]);
};

/**
 * Create a minimal valid JPEG buffer for testing
 */
const createTestJpegBuffer = (): Buffer => {
  // Minimal valid JPEG (1x1 red pixel)
  return Buffer.from([
    0xff, 0xd8, 0xff, 0xe0, 0x00, 0x10, 0x4a, 0x46, // JPEG SOI + APP0
    0x49, 0x46, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x00, 0xff, 0xdb, 0x00, 0x43, // DQT
    0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08,
    0x07, 0x07, 0x07, 0x09, 0x09, 0x08, 0x0a, 0x0c,
    0x14, 0x0d, 0x0c, 0x0b, 0x0b, 0x0c, 0x19, 0x12,
    0x13, 0x0f, 0x14, 0x1d, 0x1a, 0x1f, 0x1e, 0x1d,
    0x1a, 0x1c, 0x1c, 0x20, 0x24, 0x2e, 0x27, 0x20,
    0x22, 0x2c, 0x23, 0x1c, 0x1c, 0x28, 0x37, 0x29,
    0x2c, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1f, 0x27,
    0x39, 0x3d, 0x38, 0x32, 0x3c, 0x2e, 0x33, 0x34,
    0x32, 0xff, 0xc0, 0x00, 0x0b, 0x08, 0x00, 0x01,
    0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xff, 0xc4,
    0x00, 0x1f, 0x00, 0x00, 0x01, 0x05, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
    0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0xff,
    0xc4, 0x00, 0xb5, 0x10, 0x00, 0x02, 0x01, 0x03,
    0x03, 0x02, 0x04, 0x03, 0x05, 0x05, 0x04, 0x04,
    0x00, 0x00, 0x01, 0x7d, 0x01, 0x02, 0x03, 0x00,
    0x04, 0x11, 0x05, 0x12, 0x21, 0x31, 0x41, 0x06,
    0x13, 0x51, 0x61, 0x07, 0x22, 0x71, 0x14, 0x32,
    0x81, 0x91, 0xa1, 0x08, 0x23, 0x42, 0xb1, 0xc1,
    0x15, 0x52, 0xd1, 0xf0, 0x24, 0x33, 0x62, 0x72,
    0x82, 0x09, 0x0a, 0x16, 0x17, 0x18, 0x19, 0x1a,
    0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x34, 0x35,
    0x36, 0x37, 0x38, 0x39, 0x3a, 0x43, 0x44, 0x45,
    0x46, 0x47, 0x48, 0x49, 0x4a, 0x53, 0x54, 0x55,
    0xff, 0xda, 0x00, 0x08, 0x01, 0x01, 0x00, 0x00,
    0x3f, 0x00, 0xfb, 0xd5, 0x00, 0x00, 0x00, 0x00,
    0xff, 0xd9, // EOI
  ]);
};

// ============================================================================
// UPLOAD TESTS
// ============================================================================

describe("Upload Routes", () => {
  // Clean up uploaded test files after all tests
  afterAll(async () => {
    const uploadsDir = path.join(process.cwd(), "uploads");
    if (fs.existsSync(uploadsDir)) {
      const files = fs.readdirSync(uploadsDir);
      for (const file of files) {
        if (file.startsWith("test-")) {
          fs.unlinkSync(path.join(uploadsDir, file));
        }
      }
    }
  });

  describe("POST /api/auth/upload-image", () => {
    it("should upload a valid PNG image successfully", async () => {
      // ARRANGE: Create a test PNG buffer
      const pngBuffer = createTestPngBuffer();

      // ACT: Upload the image
      const response = await request(app)
        .post("/api/auth/upload-image")
        .attach("image", pngBuffer, "test-image.png");

      // ASSERT: Check response
      expect(response.status).toBe(200);
      expect(response.body).toHaveProperty("imageUrl");
      expect(response.body.imageUrl).toMatch(/\/uploads\/.+\.png$/);
    });

    it("should upload a valid JPEG image successfully", async () => {
      // ARRANGE: Create a test JPEG buffer
      const jpegBuffer = createTestJpegBuffer();

      // ACT: Upload the image
      const response = await request(app)
        .post("/api/auth/upload-image")
        .attach("image", jpegBuffer, "test-image.jpg");

      // ASSERT: Check response
      expect(response.status).toBe(200);
      expect(response.body).toHaveProperty("imageUrl");
      expect(response.body.imageUrl).toMatch(/\/uploads\/.+\.jpg$/);
    });

    it("should return 400 when no file is uploaded", async () => {
      // ACT: Send request without file
      const response = await request(app).post("/api/auth/upload-image");

      // ASSERT: Should return error
      expect(response.status).toBe(400);
      expect(response.body.message).toBe("No file uploaded");
    });

    it("should reject non-image files", async () => {
      // ARRANGE: Create a text file buffer
      const textBuffer = Buffer.from("This is not an image file");

      // ACT: Try to upload a text file
      const response = await request(app)
        .post("/api/auth/upload-image")
        .attach("image", textBuffer, "test-file.txt");

      // ASSERT: Should reject with error (multer throws error for invalid file type)
      expect(response.status).toBe(500);
    });
  });
});

